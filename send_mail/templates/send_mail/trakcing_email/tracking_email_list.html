{% extends "base.html" %}
{% block site_title %}
<title>Fiverr Email Scrapping List - PyTeam</title>
{% endblock site_title %}
{% block content %}
<style>
  .btn {
    display: inline-block;
    padding: 8px 14px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: bold;
    transition: background 0.3s, transform 0.2s;
  }

  .btn-primary {
    background: #243447;
    color: #fff;
  }

  .btn-primary:hover {
    background: #1a2530;
    transform: translateY(-1px);
  }

  h2 {
    margin-top: 0;
    color: #243447;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    /* margin-top: 20px; */
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
  }

  th {
    background: #243447;
    color: #fff;
    padding: 12px 10px;
    text-align: left;
    font-size: 14px;
  }

  td {
    padding: 10px;
    border-bottom: 1px solid #eee;
    font-size: 14px;
  }
  tbody td, thead th {
    width: 11%;
  }

  /* Adjust the wrapper for the table */
  .table-wrap {
    position: relative;
    max-height: 500px;  /* Set a height for scrollable area */
    overflow-y: auto;   /* Allow vertical scrolling */
  }
  thead, tbody {
    display: block;
  }

  thead {
    width: 100%;
    background-color: #243447;
    color: white;
  }
  tbody {
    height: 250px;  /* Adjust the height based on your needs */
    overflow-y: auto;
    display: block;
    width: 100%;
    background-color: white;
  }


  tr:nth-child(even) {
    background: #f9f9f9;
  }

  tr:hover {
    background: #f1f7ff;
  }

  .no-data {
    text-align: center;
    padding: 20px;
    font-style: italic;
    color: #666;
  }

  .filter-bar {
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 5;
    padding: 8px;
    border: 1px solid #eee;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, .04);
  }

  .filter-bar label {
    display: block;
    margin-bottom: 4px;
  }

  /* overlay loader */
  .ajax-loading {
    position: absolute;
    inset: 0;
    display: none;
    place-items: center;
    background: rgba(255, 255, 255, .6);
    backdrop-filter: blur(1px);
    z-index: 10;
  }

  .ajax-loading.show {
    display: grid;
  }

  .spinner {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 3px solid #ddd;
    border-top-color: #243447;
    animation: spin .7s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>

<p id="result_hint" style="margin:6px 0 0;color:#666;font-size:13px;"></p>


{% include "./_filtering_form.html" with data_list=data_list %}

<div class="table-wrap">
  <div class="ajax-loading" id="ajaxLoading">
    <div class="spinner"></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>No.</th>
        <th>Email</th>
        <th>LMS</th>
        <th>Country</th>
        <th>Event</th>
        <th>Last Event at</th>
        <th>Category</th>
        <th>Sub-category</th>
        <th>Follow Stage</th>
      </tr>
    </thead>
    <tbody id="tableBody">
      {% include "./_email_rows.html" with data_list=data_list %}
    </tbody>
  </table>

  <div id="pagination">
    {% include "./_pagination.html" with page_obj=page_obj %}
  </div>

</div>

<script>
  (function () {
    const form = document.getElementById("filterForm");
    const tableBody = document.getElementById("tableBody");
    const pagination = document.getElementById("pagination");
    
    const hint = document.getElementById("result_hint");
    const overlay = document.getElementById("ajaxLoading");

    if (!form || !tableBody || !pagination) return;

    let currentController = null;
    let loaderTimer = null;

    function showLoaderDelayed() {
      // only show if request lasts >150ms to avoid flicker
      clearTimeout(loaderTimer);
      loaderTimer = setTimeout(() => {
        overlay && overlay.classList.add('show');
        // disable all form controls while loading
        Array.from(form.elements).forEach(el => el.disabled = true);
        pagination.style.pointerEvents = 'none';
        pagination.style.opacity = '0.6';
      }, 150);
    }

    function hideLoader() {
      clearTimeout(loaderTimer);
      overlay && overlay.classList.remove('show');
      Array.from(form.elements).forEach(el => el.disabled = false);
      pagination.style.pointerEvents = '';
      pagination.style.opacity = '';
    }

    function formQS() {
      const fd = new FormData(form);
      const p = new URLSearchParams();
      for (const [k, v] of fd.entries()) {
        if (v !== null && String(v).trim() !== "") p.append(k, v);
      }
      return p;
    }

    async function loadData(params, push = true) {
      // Abort any in-flight request
      if (currentController) currentController.abort();
      currentController = new AbortController();

      const qs = params.toString();
      const url = qs ? (`?${qs}`) : location.pathname;

      showLoaderDelayed();

      try {
        const res = await fetch(url + (qs ? '&' : '?') + 'partial=1', {
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          signal: currentController.signal,
          cache: 'no-store',
          method: 'GET',
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        tableBody.innerHTML = data.rows_html || '';
        pagination.innerHTML = data.pagination_html || '';

        const totalCount = document.getElementById("total_count");
        if (totalCount) {
          totalCount.textContent = (data.has_filters
            ? `Showing ${data.count} filtered result${data.count === 1 ? '' : 's'}`
            : `Total Collection Email: ${data.count}`);
        }
        if (hint) {
          hint.textContent = data.has_filters ? 'Filters applied. Use Reset to see all data.' : '';
        }
        if (push) {
          const next = qs ? (`?${qs}`) : location.pathname;
          history.pushState({ qs }, '', next);
        }
      } catch (err) {
        if (err.name === 'AbortError') {
          // ignored: superseded by a newer request
        } else {
          console.error(err);
          if (hint) hint.textContent = 'Failed to load data. Please try again.';
        }
      } finally {
        hideLoader();
        currentController = null;
      }
    }

    // Submit -> AJAX (no full reload)
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const p = formQS();
      p.delete('page'); // reset to page 1 when filters change
      loadData(p, true);
    });

    // Pagination clicks -> AJAX
    pagination.addEventListener('click', function (e) {
      const a = e.target.closest('a[href]'); // data-page optional
      if (!a) return;
      // Only intercept same-origin links
      const u = new URL(a.href, location.origin);
      if (u.origin !== location.origin || u.pathname !== location.pathname) return;

      e.preventDefault();
      const p = formQS();
      const page = u.searchParams.get('page') || a.getAttribute('data-page') || '1';
      p.set('page', page);
      loadData(p, true);
    });

    // Back/forward
    window.addEventListener('popstate', function () {
      const qs = (location.search || '').replace(/^\?/, '');
      const params = new URLSearchParams(qs);
      loadData(params, false);
    });
  })();
</script>


{% endblock %}